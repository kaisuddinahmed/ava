<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | AVA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass-panel {
            background: transparent;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>

<body class="bg-gray-50 text-black min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="border-b border-gray-200 bg-white sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer" onclick="window.location.href='/'" data-nav="internal">
                <!-- Text Logo Only -->
                <span class="font-bold text-2xl tracking-tighter text-black uppercase">AVA</span>
            </div>
            <a href="/" class="text-sm font-bold text-gray-500 hover:text-black uppercase tracking-wide" data-nav="internal">← Continue Shopping</a>
        </div>
    </nav>

    <main class="flex-grow max-w-4xl mx-auto w-full p-6 py-10" id="main-content">
        <h1 class="text-3xl font-black uppercase tracking-tighter mb-8 text-black">Secure Checkout</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">

            <!-- LEFT COLUMN: Cart & Form -->
            <div class="md:col-span-2 space-y-8">

                <!-- Step 1: Cart Review -->
                <div class="glass-panel p-6 bg-white" id="cart-section">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 uppercase tracking-wide">
                        <span
                            class="bg-black text-white text-xs w-6 h-6 flex items-center justify-center font-bold">1</span>
                        Your Order
                    </h2>
                    <div id="cart-items" class="space-y-4">
                        <!-- Injected JS -->
                    </div>
                    <div id="empty-cart-msg" class="hidden text-center py-8 text-gray-500">
                        Your cart is empty. <a href="/" class="text-black font-bold border-b border-black hover:text-gray-700" data-nav="internal">Go
                            Shop</a>
                    </div>
                </div>

                <!-- Step 2: Shipping Information -->
                <div class="glass-panel p-6 bg-white opacity-50 pointer-events-none transition" id="shipping-section">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 uppercase tracking-wide">
                        <span class="bg-gray-400 text-white text-xs w-6 h-6 flex items-center justify-center font-bold"
                            id="step-2-indicator">2</span>
                        Shipping Information
                    </h2>

                    <form id="shipping-form" class="space-y-4">
                        <!-- Contact Information -->
                        <div class="space-y-4">
                            <h3 class="text-sm font-bold uppercase text-gray-500">Contact</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Full Name</label>
                                    <input type="text" id="field-fullName"
                                        class="w-full bg-gray-50 border border-gray-300 p-3 text-sm focus:border-black outline-none transition"
                                        placeholder="John Doe" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Email</label>
                                    <input type="email" id="field-email"
                                        class="w-full bg-gray-50 border border-gray-300 p-3 text-sm focus:border-black outline-none transition"
                                        placeholder="john@example.com" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Phone</label>
                                <input type="tel" id="field-phone"
                                    class="w-full bg-gray-50 border border-gray-300 p-3 text-sm focus:border-black outline-none transition"
                                    placeholder="+1 (555) 123-4567" required>
                            </div>
                        </div>

                        <!-- Shipping Address -->
                        <div class="space-y-4 pt-4 border-t border-gray-200">
                            <h3 class="text-sm font-bold uppercase text-gray-500">Address</h3>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Street Address</label>
                                <input type="text" id="field-address"
                                    class="w-full bg-gray-50 border border-gray-300 p-3 text-sm focus:border-black outline-none transition"
                                    placeholder="123 Tech Blvd" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">City</label>
                                    <input type="text" id="field-city"
                                        class="w-full bg-gray-50 border border-gray-300 p-3 text-sm focus:border-black outline-none transition"
                                        placeholder="New York" required>
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Zip Code</label>
                                    <input type="text" id="field-zip"
                                        class="w-full bg-gray-50 border border-gray-300 p-3 text-sm focus:border-black outline-none transition"
                                        placeholder="10001" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Country</label>
                                <input type="text" id="field-country"
                                    class="w-full bg-gray-50 border border-gray-300 p-3 text-sm focus:border-black outline-none transition"
                                    placeholder="United States" required>
                            </div>
                        </div>

                        <!-- Shipping Method -->
                        <div class="space-y-3 pt-4 border-t border-gray-200">
                            <h3 class="text-sm font-bold uppercase text-gray-500">Shipping Method</h3>
                            <div class="space-y-2">
                                <label
                                    class="flex items-center justify-between glass-panel p-4 cursor-pointer hover:border-black transition bg-white">
                                    <div class="flex items-center gap-3">
                                        <input type="radio" name="shipping" value="standard" class="shipping-option"
                                            data-name="Standard Shipping" data-cost="5" data-time="48 hrs" checked>
                                        <div>
                                            <div class="text-sm font-bold text-black">Standard Shipping</div>
                                            <div class="text-xs text-gray-500">Delivery in 48 hours</div>
                                        </div>
                                    </div>
                                    <span class="text-sm font-bold text-black">$5</span>
                                </label>
                                <label
                                    class="flex items-center justify-between glass-panel p-4 cursor-pointer hover:border-black transition bg-white">
                                    <div class="flex items-center gap-3">
                                        <input type="radio" name="shipping" value="fast" class="shipping-option"
                                            data-name="Fast Shipping" data-cost="15" data-time="24 hrs">
                                        <div>
                                            <div class="text-sm font-bold text-black">Fast Shipping</div>
                                            <div class="text-xs text-gray-500">Delivery in 24 hours</div>
                                        </div>
                                    </div>
                                    <span class="text-sm font-bold text-black">$15</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Step 3: Payment -->
                <div class="glass-panel p-6 bg-white opacity-50 pointer-events-none transition" id="payment-section">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 uppercase tracking-wide">
                        <span class="bg-gray-400 text-white text-xs w-6 h-6 flex items-center justify-center font-bold"
                            id="step-3-indicator">3</span>
                        Payment
                    </h2>
                    <form id="payment-form">
                         <div class="space-y-4">
                            <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Payment Method</label>
                            <div class="flex gap-4">
                                <label
                                    class="flex-1 glass-panel p-4 cursor-pointer hover:border-black transition flex items-center gap-2 bg-white">
                                    <input type="radio" name="payment" value="cod" class="accent-black" checked>
                                    <span class="text-sm font-bold text-black">Cash on Delivery</span>
                                </label>
                                <label
                                    class="flex-1 glass-panel p-4 cursor-pointer hover:border-black transition flex items-center gap-2 bg-white">
                                    <input type="radio" name="payment" value="card" class="accent-black">
                                    <span class="text-sm font-bold text-black">Credit Card</span>
                                </label>
                            </div>
                        </div>

                        <!-- Card Details (Hidden by default) -->
                        <div id="card-details" class="hidden mt-6 space-y-4 pt-4 border-t border-gray-200">
                             <div>
                                <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Card Number</label>
                                <input type="text" id="field-card-number"
                                    class="w-full bg-gray-50 border border-gray-300 p-3 text-sm focus:border-black outline-none transition font-mono"
                                    placeholder="0000 0000 0000 0000" maxlength="19">
                             </div>
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">Expiry</label>
                                    <input type="text" id="field-card-expiry"
                                        class="w-full bg-gray-50 border border-gray-300 p-3 text-sm focus:border-black outline-none transition font-mono"
                                        placeholder="MM/YY" maxlength="5">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold uppercase text-gray-500 mb-1">CVC</label>
                                    <input type="text" id="field-card-cvc"
                                        class="w-full bg-gray-50 border border-gray-300 p-3 text-sm focus:border-black outline-none transition font-mono"
                                        placeholder="123" maxlength="3">
                                </div>
                             </div>
                        </div>
                    </form>
                </div>

                <!-- Step 4: Review -->
                <div class="glass-panel p-6 bg-white opacity-50 pointer-events-none transition" id="review-section">
                     <h2 class="text-xl font-bold mb-4 flex items-center gap-2 uppercase tracking-wide">
                        <span class="bg-gray-400 text-white text-xs w-6 h-6 flex items-center justify-center font-bold"
                            id="step-4-indicator">4</span>
                        Review Order
                    </h2>
                    <div id="review-content" class="text-sm space-y-4 text-gray-600">
                        <!-- Populated via JS -->
                        <p class="italic text-gray-400">Please complete previous steps to review your order.</p>
                    </div>
                </div>

            </div>

            <!-- RIGHT COLUMN: Summary -->
            <div class="md:col-span-1">
                <div class="glass-panel p-6 bg-white sticky top-24 border border-gray-200">
                    <h3 class="font-bold text-black text-xs uppercase mb-4 tracking-widest border-b border-gray-200 pb-2">Order Summary</h3>
                    
                    <!-- Coupon Section (Tracking Enabled) -->
                    <div class="mb-4" data-section="coupon">
                        <div class="flex gap-2">
                            <input type="text" placeholder="Promo / Gift Code" 
                                class="w-full bg-gray-50 border border-gray-300 p-2 text-xs text-black focus:border-black outline-none transition uppercase placeholder-gray-500"
                                data-field="coupon">
                            <button class="bg-black text-white px-4 py-2 text-xs font-bold uppercase tracking-wider hover:bg-gray-800 transition">Apply</button>
                        </div>
                    </div>

                    <div class="space-y-2 text-sm mb-4 border-b border-gray-200 pb-4">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Subtotal</span>
                            <span id="summary-subtotal" class="font-bold">$0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Shipping</span>
                            <span class="text-green-600 font-bold">FREE</span>
                        </div>
                        <div
                            class="flex justify-between font-black text-black text-lg mt-2 pt-2 border-t border-gray-200">
                            <span>Total</span>
                            <span id="summary-total">$0.00</span>
                        </div>
                    </div>
                    <button id="btn-submit"
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold uppercase tracking-widest py-4 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg">
                        Proceed to Checkout
                    </button>
                    <p class="text-[10px] text-gray-400 text-center mt-3 uppercase tracking-wide">Free 30-day returns. Secure checkout.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- SUCCESS STATE (Hidden) -->
    <div id="success-view"
        class="hidden min-h-screen flex flex-col items-center justify-center p-6 text-center relative overflow-hidden">
        <!-- Confetti Canvas -->
        <canvas id="confetti-canvas" class="absolute inset-0 pointer-events-none z-0"></canvas>

        <div class="relative z-10 flex flex-col items-center">
            <div
                class="w-20 h-20 bg-black rounded-full flex items-center justify-center mb-6 shadow-xl animate-bounce">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>

            <h1 class="text-4xl font-black uppercase tracking-tighter mb-2 text-black">Order Confirmed!</h1>

            <!-- Dynamic Success Message -->
            <div id="ai-success-msg"
                class="hidden mb-6 bg-black text-white px-4 py-2 rounded-full text-xs font-bold flex items-center gap-2 uppercase tracking-wide">
                <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                Conversion Saved by Sales Agent
            </div>

            <p class="text-gray-500 mb-8 max-w-md">Thank you, Alex. Your order <span
                    class="text-black font-bold font-mono">#ORD-9928</span> has been placed successfully.</p>
            <button onclick="window.location.href='/'" data-nav="internal"
                class="bg-black text-white px-8 py-4 font-bold uppercase tracking-wider hover:bg-gray-800 transition shadow-lg hover:shadow-xl hover:scale-105 transform">
                Back to Store
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script type="module">
        import { getCart, removeFromCart, clearCart, getCartTotal, getUser } from '/src/store/store.ts';

        const cartContainer = document.getElementById('cart-items');
        const emptyMsg = document.getElementById('empty-cart-msg');
        const subtotalEl = document.getElementById('summary-subtotal');
        const totalEl = document.getElementById('summary-total');
        
        const shippingSection = document.getElementById('shipping-section');
        const paymentSection = document.getElementById('payment-section');
        const reviewSection = document.getElementById('review-section');
        
        const submitBtn = document.getElementById('btn-submit');
        let step = 1;

        function renderCart() {
            const cart = getCart();
            cartContainer.innerHTML = '';

            if (cart.length === 0) {
                emptyMsg.classList.remove('hidden');
                submitBtn.disabled = true;
                subtotalEl.innerText = '$0.00';
                totalEl.innerText = '$0.00';
                return;
            } else {
                emptyMsg.classList.add('hidden');
                submitBtn.disabled = false;
            }

            cart.forEach(item => {
                const el = document.createElement('div');
                el.className = "flex gap-4 items-center bg-gray-50 border border-gray-200 p-3";
                el.innerHTML = `
                    <div class="w-16 h-16 bg-gray-200 flex-shrink-0">
                        <img src="${item.image}" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-sm line-clamp-1 text-black uppercase">${item.name}</h4>
                        <div class="text-xs text-gray-500 font-bold">$${item.price.toFixed(2)} x ${item.quantity}</div>
                    </div>
                    <div class="font-bold text-sm text-black">$${(item.price * item.quantity).toFixed(2)}</div>
                    <button class="text-gray-400 hover:text-black p-1 remove-btn transform hover:scale-110 transition" data-id="${item.id}">×</button>
                `;
                cartContainer.appendChild(el);
            });

            // Summary
            const total = getCartTotal();
            const formatted = `$${total.toFixed(2)}`;
            subtotalEl.innerText = formatted;
            totalEl.innerText = formatted;

            // Bind Remove
            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.onclick = () => {
                    const itemId = btn.dataset.id;
                    const cartItem = getCart().find(i => i.id === itemId);
                    removeFromCart(itemId);
                    // Track removal (only cart_item_removed, remove_from_cart was duplicate)
                    sendEvent('cart_item_removed', { product_id: itemId, product_name: cartItem?.name, product_price: cartItem?.price, location: 'checkout' });
                    renderCart(); // Re-render
                };
            });
        }

        // Send tracking event
        async function sendEvent(eventType, payload = {}) {
            try {
                const sessionId = window.sessionStorage.getItem('analyst_session_id') || Date.now().toString();
                window.sessionStorage.setItem('analyst_session_id', sessionId);

                const event = {
                    session_id: sessionId,
                    event_type: eventType,
                    url: window.location.href,
                    timestamp: new Date().toISOString(),
                    payload
                };

                await fetch('http://localhost:3000/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(event)
                });
            } catch (e) {
                console.error('Tracking error:', e);
            }
        }

        // Emit cart_opened event (user clicked Cart button — viewing cart summary)
        setTimeout(() => {
            const cart = getCart();
            sendEvent('cart_opened', {
                item_count: cart.length,
                total_value: getCartTotal(),
                items: cart.map(i => ({ product_id: i.id, product_name: i.name, price: i.price }))
            });
        }, 500);

        // Track form field changes
        const formFields = ['fullName', 'email', 'phone', 'country', 'address'];
        formFields.forEach(fieldName => {
            const input = document.getElementById(`field-${fieldName}`);
            if (input) {
                input.addEventListener('blur', (e) => {
                    if (e.target.value.trim()) {
                        sendEvent('form_field_change', {
                            form_type: 'Shipping',
                            field_name: fieldName,
                            value: e.target.value.trim()
                        });
                    }
                });
            }
        });

        // V2: Idle detection on form fields (20s threshold -> checkout_idle)
        let fieldIdleTimers = {};
        formFields.forEach(fieldName => {
            const input = document.getElementById(`field-${fieldName}`);
            if (input) {
                input.addEventListener('focus', () => {
                    fieldIdleTimers[fieldName] = setTimeout(() => {
                        sendEvent('checkout_idle', { field_name: fieldName, idle_duration_ms: 20000 });
                    }, 20000);
                });
                input.addEventListener('input', () => {
                    clearTimeout(fieldIdleTimers[fieldName]);
                    fieldIdleTimers[fieldName] = setTimeout(() => {
                        sendEvent('checkout_idle', { field_name: fieldName, idle_duration_ms: 20000 });
                    }, 20000);
                });
                input.addEventListener('blur', () => {
                    clearTimeout(fieldIdleTimers[fieldName]);
                });
            }
        });

        // V2: shipping_method_viewed on mouseenter shipping section
        let shippingViewed = false;
        const shippingOptionsArea = document.querySelector('.shipping-option')?.closest('.space-y-3');
        if (shippingOptionsArea) {
            shippingOptionsArea.addEventListener('mouseenter', () => {
                if (!shippingViewed) {
                    shippingViewed = true;
                    sendEvent('shipping_method_viewed', {});
                }
            });
        }

        // Track shipping option selection
        document.querySelectorAll('.shipping-option').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    sendEvent('shipping_option_selected', {
                        option_name: e.target.dataset.name,
                        cost: parseFloat(e.target.dataset.cost),
                        delivery_time: e.target.dataset.time
                    });
                }
            });
        });

        // V2: payment_method_viewed on mouseenter payment section
        let paymentViewed = false;
        const paymentMethodSection = document.querySelector('[name="payment"]')?.closest('.pt-4');
        if (paymentMethodSection) {
            paymentMethodSection.addEventListener('mouseenter', () => {
                if (!paymentViewed) {
                    paymentViewed = true;
                    sendEvent('payment_method_viewed', {});
                }
            });
        }

        // V2: payment_method_selected on radio change
        document.querySelectorAll('[name="payment"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.checked) {
                    const label = e.target.closest('label')?.querySelector('span')?.textContent?.trim() || 'unknown';
                    sendEvent('payment_method_selected', { method: label });
                }
            });
        });

        // Track delivery slot selection
        const deliverySlot = document.getElementById('delivery-slot');
        if (deliverySlot) {
            deliverySlot.addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                sendEvent('delivery_slot_selected', {
                    slot_name: e.target.value.charAt(0).toUpperCase() + e.target.value.slice(1),
                    time_range: selectedOption.dataset.time
                });
            });
        }

        // Submit button logic
        submitBtn.onclick = () => {
            if (step === 1) {
                // To Shipping
                step = 2;
                shippingSection.classList.remove('opacity-50', 'pointer-events-none');
                shippingSection.scrollIntoView({ behavior: 'smooth' });
                document.getElementById('step-2-indicator').classList.add('bg-black', 'text-white');
                submitBtn.innerText = "Continue to Payment";
                
                // Track Checkout Started
                const cart = getCart();
                sendEvent('checkout_started', {
                    items: cart.map(i => ({ product_id: i.id, name: i.name, price: i.price, quantity: i.quantity })),
                    total_value: getCartTotal()
                });
            } else if (step === 2) {
                // To Payment
                if(document.getElementById('shipping-form').checkValidity()) {
                    step = 3;
                    paymentSection.classList.remove('opacity-50', 'pointer-events-none');
                    paymentSection.scrollIntoView({ behavior: 'smooth' });
                    document.getElementById('step-3-indicator').classList.add('bg-black', 'text-white');
                    submitBtn.innerText = "Review Order";
                } else {
                    document.getElementById('shipping-form').reportValidity();
                }
            } else if (step === 3) {
                // To Review
                if(document.getElementById('payment-form').checkValidity()) {
                    step = 4;
                    reviewSection.classList.remove('opacity-50', 'pointer-events-none');
                    reviewSection.scrollIntoView({ behavior: 'smooth' });
                    document.getElementById('step-4-indicator').classList.add('bg-black', 'text-white');
                    submitBtn.innerText = "Place Order";
                    submitBtn.classList.remove('bg-black');
                    submitBtn.classList.add('bg-green-600');
                    renderReview();
                } else {
                     document.getElementById('payment-form').reportValidity();
                }
            } else if (step === 4) {
                 // Final Submit
                 const user = getUser();
                 document.getElementById('main-content').classList.add('hidden');
                 const successView = document.getElementById('success-view');
                 successView.classList.remove('hidden');

                 // Trigger Confetti (Existing Logic)
                 const canvas = document.getElementById('confetti-canvas');
                 const myConfetti = confetti.create(canvas, { resize: true });

                 if (user.hasIntervention) {
                     document.getElementById('ai-success-msg').classList.remove('hidden');
                     myConfetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: ['#000000', '#333333', '#888888'] });
                 } else {
                     myConfetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
                 }
                 
                 // Tracking
                 sendEvent('order_placed', { order_id: 'ORD-' + Math.floor(Math.random()*10000), total_value: getCartTotal(), item_count: getCart().length });
                 clearCart();
            }
        };

        function renderReview() {
            const shipData = {
                name: document.getElementById('field-fullName').value,
                address: document.getElementById('field-address').value,
                city: document.getElementById('field-city').value,
                country: document.getElementById('field-country').value,
            };
            const method = document.querySelector('input[name="shipping"]:checked').dataset.name;
            const payMethod = document.querySelector('input[name="payment"]:checked').value === 'card' ? 'Credit Card' : 'Cash on Delivery';
            
            document.getElementById('review-content').innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <h4 class="font-bold text-black uppercase text-xs mb-1">Shipping To:</h4>
                        <p>${shipData.name}<br>${shipData.address}<br>${shipData.city}, ${shipData.country}</p>
                    </div>
                    <div>
                         <h4 class="font-bold text-black uppercase text-xs mb-1">Method:</h4>
                         <p>${method}</p>
                         <h4 class="font-bold text-black uppercase text-xs mt-2 mb-1">Payment:</h4>
                         <p>${payMethod}</p>
                    </div>
                </div>
            `;
        }

        // Payment Toggle Logic
        document.querySelectorAll('input[name="payment"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const cardDetails = document.getElementById('card-details');
                if(e.target.value === 'card') {
                    cardDetails.classList.remove('hidden');
                    document.getElementById('field-card-number').required = true;
                    document.getElementById('field-card-expiry').required = true;
                    document.getElementById('field-card-cvc').required = true;
                } else {
                    cardDetails.classList.add('hidden');
                    document.getElementById('field-card-number').required = false;
                    document.getElementById('field-card-expiry').required = false;
                    document.getElementById('field-card-cvc').required = false;
                }
            });
        });

        // Auto-Fill User
        const savedUser = localStorage.getItem('user');
        if(savedUser) {
            const u = JSON.parse(savedUser);
            document.getElementById('field-fullName').value = u.name || '';
            document.getElementById('field-email').value = u.email || '';
        }

        // Init
        renderCart();
    </script>
</body>

</html>