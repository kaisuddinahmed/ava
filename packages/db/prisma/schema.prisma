// ============================================================================
// AVA — Prisma Schema
// SQLite (dev) / PostgreSQL (prod)
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ---------------------------------------------------------------------------
// Session — one visitor session on the store
// ---------------------------------------------------------------------------
model Session {
  id              String   @id @default(uuid())
  visitorId       String?
  siteUrl         String
  startedAt       DateTime @default(now())
  lastActivityAt  DateTime @default(now())
  deviceType      String   // mobile | tablet | desktop
  referrerType    String   // direct | organic | paid | social | email
  isLoggedIn      Boolean  @default(false)
  isRepeatVisitor Boolean  @default(false)
  cartValue       Float    @default(0)
  cartItemCount   Int      @default(0)
  status          String   @default("active") // active | idle | ended

  // MSWIM session-level tracking
  totalInterventionsFired Int     @default(0)
  totalDismissals         Int     @default(0)
  totalConversions        Int     @default(0)
  suppressNonPassive      Boolean @default(false)

  // Analytics fields (Phase 1 — all nullable for safe migration)
  endedAt           DateTime?
  totalPageViews    Int       @default(0)
  totalTimeOnSiteMs Int?
  entryPage         String?
  exitPage          String?
  landingReferrer   String?
  utmSource         String?
  utmMedium         String?
  utmCampaign       String?
  utmContent        String?
  utmTerm           String?

  events        TrackEvent[]
  evaluations   Evaluation[]
  interventions Intervention[]

  @@index([visitorId, siteUrl, startedAt])
  @@index([referrerType, startedAt])
  @@index([siteUrl, startedAt])
}

// ---------------------------------------------------------------------------
// TrackEvent — individual behavioral event from the widget
// ---------------------------------------------------------------------------
model TrackEvent {
  id        String   @id @default(uuid())
  sessionId String
  session   Session  @relation(fields: [sessionId], references: [id])
  timestamp DateTime @default(now())
  category  String   // navigation | search | product | cart | checkout
  eventType String   // click | scroll | hover | form_input | page_view
  frictionId String? // F001–F325 if detected client-side
  pageType  String   // landing | category | pdp | cart | checkout | other
  pageUrl   String
  rawSignals String  // JSON blob
  metadata  String?

  // Analytics fields — promoted from rawSignals/page_context (all nullable)
  previousPageUrl       String?
  timeOnPageMs          Int?
  scrollDepthPct        Int?
  sessionSequenceNumber Int?
  siteUrl               String?  // denormalized from Session for direct filtering

  @@index([sessionId, timestamp])
  @@index([frictionId])
  @@index([siteUrl, pageType, timestamp])
  @@index([sessionId, eventType])
  @@index([pageUrl, timestamp])
}

// ---------------------------------------------------------------------------
// Evaluation — LLM analysis result with MSWIM scores
// ---------------------------------------------------------------------------
model Evaluation {
  id            String   @id @default(uuid())
  sessionId     String
  session       Session  @relation(fields: [sessionId], references: [id])
  timestamp     DateTime @default(now())
  eventBatchIds String   // JSON array of TrackEvent IDs

  // LLM output
  narrative      String // Prose reasoning (EVALUATE tab)
  frictionsFound String // JSON array of friction_ids

  // MSWIM 5 signals (0–100)
  intentScore      Float
  frictionScore    Float
  clarityScore     Float
  receptivityScore Float
  valueScore       Float

  // MSWIM composite + decision
  compositeScore   Float  // Weighted sum
  weightsUsed      String // JSON: weight profile applied
  tier             String // MONITOR | PASSIVE | NUDGE | ACTIVE | ESCALATE
  decision         String // fire | suppress | queue
  gateOverride     String? // Which gate triggered, null if none
  interventionType String? // passive | nudge | active | escalate
  reasoning        String // Why

  intervention Intervention?

  @@index([sessionId, timestamp])
  @@index([tier])
}

// ---------------------------------------------------------------------------
// Intervention — action sent to the widget
// ---------------------------------------------------------------------------
model Intervention {
  id           String     @id @default(uuid())
  sessionId    String
  session      Session    @relation(fields: [sessionId], references: [id])
  evaluationId String     @unique
  evaluation   Evaluation @relation(fields: [evaluationId], references: [id])
  timestamp    DateTime   @default(now())

  type       String // passive | nudge | active | escalate
  actionCode String
  frictionId String
  payload    String // JSON sent to widget

  // Outcome tracking (feeds MSWIM tuning)
  status           String    @default("sent") // sent | delivered | dismissed | converted | ignored
  deliveredAt      DateTime?
  dismissedAt      DateTime?
  convertedAt      DateTime?
  ignoredAt        DateTime?
  conversionAction String?

  // MSWIM snapshot at fire time (for A/B analysis)
  mswimScoreAtFire Float
  tierAtFire       String

  @@index([sessionId, timestamp])
  @@index([status])
  @@index([type, status])
}

// ---------------------------------------------------------------------------
// ScoringConfig — configurable MSWIM weight profiles
// ---------------------------------------------------------------------------
model ScoringConfig {
  id       String  @id @default(uuid())
  name     String  // "default", "aggressive", "conservative", "site_xyz"
  siteUrl  String? // null = global default, or site-specific override
  isActive Boolean @default(false)

  // Signal weights (must sum to 1.0)
  weightIntent      Float @default(0.25)
  weightFriction    Float @default(0.25)
  weightClarity     Float @default(0.15)
  weightReceptivity Float @default(0.20)
  weightValue       Float @default(0.15)

  // Tier thresholds
  thresholdMonitor Float @default(29)
  thresholdPassive Float @default(49)
  thresholdNudge   Float @default(64)
  thresholdActive  Float @default(79)

  // Gate config
  minSessionAgeSec        Int @default(30)
  maxActivePerSession     Int @default(2)
  maxNudgePerSession      Int @default(3)
  maxNonPassivePerSession Int @default(6)
  cooldownAfterActiveSec  Int @default(120)
  cooldownAfterNudgeSec   Int @default(60)
  cooldownAfterDismissSec Int @default(300)
  dismissalsToSuppress    Int @default(3)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([siteUrl, isActive])
}

// ---------------------------------------------------------------------------
// SiteConfig — per-site tracking & platform configuration
// ---------------------------------------------------------------------------
model SiteConfig {
  id                  String                   @id @default(uuid())
  siteUrl             String                   @unique
  platform            String                   // shopify | woocommerce | magento | custom
  trackingConfig      String                   // JSON: auto-detected selectors
  integrationStatus   String                   @default("pending") // pending | analyzing | mapped | verified | limited_active | active | failed
  activeAnalyzerRunId String?
  activeAnalyzerRun   AnalyzerRun?             @relation("ActiveAnalyzerRun", fields: [activeAnalyzerRunId], references: [id])
  analyzerRuns        AnalyzerRun[]            @relation("SiteAnalyzerRuns")
  behaviorMappings    BehaviorPatternMapping[]
  frictionMappings    FrictionMapping[]
  integrationStatuses IntegrationStatus[]
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt
}

// ---------------------------------------------------------------------------
// AnalyzerRun — lifecycle + coverage metrics for onboarding analysis
// ---------------------------------------------------------------------------
model AnalyzerRun {
  id               String   @id @default(uuid())
  siteConfigId     String
  siteConfig       SiteConfig @relation("SiteAnalyzerRuns", fields: [siteConfigId], references: [id])
  startedAt        DateTime @default(now())
  completedAt      DateTime?
  status           String   @default("queued") // queued | running | completed | failed
  phase            String   @default("detect_platform") // detect_platform | map_behaviors | map_frictions | verify | activate
  behaviorCoverage Float    @default(0) // % of B001-B614 mapped
  frictionCoverage Float    @default(0) // % of F001-F325 mapped
  avgConfidence    Float    @default(0)
  summary          String?  // JSON summary
  errorMessage     String?

  behaviorMappings    BehaviorPatternMapping[]
  frictionMappings    FrictionMapping[]
  activeForSites      SiteConfig[]        @relation("ActiveAnalyzerRun")
  integrationStatuses IntegrationStatus[]

  @@index([siteConfigId, startedAt])
  @@index([status, phase])
}

// ---------------------------------------------------------------------------
// BehaviorPatternMapping — B001-B614 mapped to site-level observables
// ---------------------------------------------------------------------------
model BehaviorPatternMapping {
  id             String   @id @default(uuid())
  analyzerRunId  String
  siteConfigId   String
  analyzerRun    AnalyzerRun @relation(fields: [analyzerRunId], references: [id])
  siteConfig     SiteConfig  @relation(fields: [siteConfigId], references: [id])
  patternId      String   // B001-B614
  patternName    String
  mappedFunction String   // add_to_cart | open_cart | search_submit | checkout_submit | ...
  eventType      String   // click | submit | hover | input | view | custom
  selector       String?
  confidence     Float    // 0.0–1.0
  source         String   // dom_rule | platform_api | llm_inferred
  evidence       String?  // JSON evidence
  isVerified     Boolean  @default(false)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([siteConfigId, patternId])
  @@index([analyzerRunId, confidence])
  @@unique([siteConfigId, patternId, mappedFunction])
}

// ---------------------------------------------------------------------------
// FrictionMapping — F001-F325 mapped to site-specific detector rules
// ---------------------------------------------------------------------------
model FrictionMapping {
  id              String   @id @default(uuid())
  analyzerRunId   String
  siteConfigId    String
  analyzerRun     AnalyzerRun @relation(fields: [analyzerRunId], references: [id])
  siteConfig      SiteConfig  @relation(fields: [siteConfigId], references: [id])
  frictionId      String   // F001-F325
  detectorType    String   // rule | llm | hybrid
  triggerEvent    String   // hover_pause | form_error | rage_click | ...
  selector        String?
  thresholdConfig String?  // JSON
  confidence      Float    // 0.0–1.0
  evidence        String?  // JSON evidence
  isVerified      Boolean  @default(false)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([siteConfigId, frictionId])
  @@index([analyzerRunId, confidence])
  @@unique([siteConfigId, frictionId, triggerEvent])
}

// ---------------------------------------------------------------------------
// TrainingDatapoint — denormalized snapshot for LLM fine-tuning export
// Joins Evaluation + Intervention outcome + Session context into one row.
// Created after an intervention reaches a terminal outcome.
// ---------------------------------------------------------------------------
model TrainingDatapoint {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  // Source references
  sessionId      String
  evaluationId   String
  interventionId String   @unique

  // Session context snapshot
  siteUrl         String
  deviceType      String  // mobile | tablet | desktop
  referrerType    String  // direct | organic | paid | social | email | referral
  isLoggedIn      Boolean
  isRepeatVisitor Boolean
  cartValue       Float
  cartItemCount   Int
  sessionAgeSec   Int     // seconds from session start to evaluation
  totalInterventionsFired Int
  totalDismissals         Int
  totalConversions        Int

  // LLM input: raw signals that fed the evaluation
  eventBatchIds  String   // JSON array of TrackEvent IDs
  rawEventData   String   // JSON: condensed event batch (category, eventType, frictionId, rawSignals)
  pageType       String   // page type at evaluation time

  // LLM output
  narrative      String   // LLM prose reasoning
  frictionsFound String   // JSON array of friction_ids

  // MSWIM scores
  intentScore      Float
  frictionScore    Float
  clarityScore     Float
  receptivityScore Float
  valueScore       Float
  compositeScore   Float
  weightsUsed      String  // JSON weight profile snapshot
  tier             String  // MONITOR | PASSIVE | NUDGE | ACTIVE | ESCALATE
  decision         String  // fire | suppress | queue
  gateOverride     String? // which gate triggered, null if none

  // Intervention details
  interventionType String  // passive | nudge | active | escalate
  actionCode       String
  frictionId       String
  mswimScoreAtFire Float
  tierAtFire       String

  // Outcome label — the training target
  outcome          String  // delivered | dismissed | converted | ignored
  conversionAction String?
  outcomeDelayMs   Int?    // ms between intervention fire and outcome

  // Quality & filtering
  qualityFlags String? // JSON: { hasOutcome, highConfidence, sufficientContext, ... }

  @@index([outcome])
  @@index([tier, outcome])
  @@index([siteUrl, createdAt])
  @@index([frictionId, outcome])
  @@index([interventionType, outcome])
  @@index([createdAt])
}

// ---------------------------------------------------------------------------
// IntegrationStatus — progress log for onboarding + activation mode
// ---------------------------------------------------------------------------
model IntegrationStatus {
  id            String   @id @default(uuid())
  siteConfigId  String
  analyzerRunId String?
  siteConfig    SiteConfig   @relation(fields: [siteConfigId], references: [id])
  analyzerRun   AnalyzerRun? @relation(fields: [analyzerRunId], references: [id])
  status        String   // analyzing | mapped | verified | limited_active | active | failed
  progress      Int      @default(0) // 0..100
  details       String?  // JSON summary payload for UI/demo
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([siteConfigId, status])
  @@index([analyzerRunId, status])
}

// ---------------------------------------------------------------------------
// ShadowComparison — dual-path evaluation comparison (LLM+MSWIM vs MSWIM-no-LLM)
// ---------------------------------------------------------------------------
model ShadowComparison {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  sessionId    String
  evaluationId String

  // Production path (LLM+MSWIM)
  prodIntentScore      Float
  prodFrictionScore    Float
  prodClarityScore     Float
  prodReceptivityScore Float
  prodValueScore       Float
  prodCompositeScore   Float
  prodTier             String
  prodDecision         String
  prodGateOverride     String?

  // Shadow path (MSWIM-no-LLM)
  shadowIntentScore      Float
  shadowFrictionScore    Float
  shadowClarityScore     Float
  shadowReceptivityScore Float
  shadowValueScore       Float
  shadowCompositeScore   Float
  shadowTier             String
  shadowDecision         String
  shadowGateOverride     String?

  // Divergence metrics
  compositeDivergence Float
  tierMatch           Boolean
  decisionMatch       Boolean
  gateOverrideMatch   Boolean

  // Context snapshot
  pageType   String
  eventCount Int
  cartValue  Float

  // Debug: synthetic hints fed to shadow runMSWIM
  syntheticHints String // JSON

  @@index([sessionId, createdAt])
  @@index([tierMatch, createdAt])
  @@index([decisionMatch, createdAt])
  @@index([compositeDivergence])
  @@index([evaluationId])
}

// ---------------------------------------------------------------------------
// JobRun — tracks scheduled and manual job executions
// ---------------------------------------------------------------------------
model JobRun {
  id           String    @id @default(uuid())
  jobName      String    // nightly_batch | drift_check | rollout_health | hourly_snapshot
  status       String    @default("running") // running | completed | failed
  startedAt    DateTime  @default(now())
  completedAt  DateTime?
  triggeredBy  String    @default("scheduler") // scheduler | api | manual
  summary      String?   // JSON: per-subtask results
  errorMessage String?
  durationMs   Int?

  @@index([jobName, startedAt])
  @@index([status])
}

// ---------------------------------------------------------------------------
// DriftSnapshot — periodic metric snapshots for trend analysis
// ---------------------------------------------------------------------------
model DriftSnapshot {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  siteUrl   String?  // null = global
  windowType String  // 1h | 6h | 24h | 7d

  // Shadow comparison agreement rates
  tierAgreementRate      Float
  decisionAgreementRate  Float
  avgCompositeDivergence Float
  sampleCount            Int

  // Signal calibration (avg by outcome)
  avgIntentConverted       Float?
  avgIntentDismissed       Float?
  avgFrictionConverted     Float?
  avgFrictionDismissed     Float?
  avgClarityConverted      Float?
  avgClarityDismissed      Float?
  avgReceptivityConverted  Float?
  avgReceptivityDismissed  Float?
  avgValueConverted        Float?
  avgValueDismissed        Float?
  avgCompositeConverted    Float?
  avgCompositeDismissed    Float?

  // Outcome rates in the window
  conversionRate Float?
  dismissalRate  Float?

  @@index([siteUrl, windowType, createdAt])
  @@index([createdAt])
}

// ---------------------------------------------------------------------------
// DriftAlert — detected scoring/model anomalies
// ---------------------------------------------------------------------------
model DriftAlert {
  id             String    @id @default(uuid())
  createdAt      DateTime  @default(now())
  siteUrl        String?   // null = global
  alertType      String    // tier_agreement_drop | decision_agreement_drop | divergence_spike | signal_shift | conversion_drop
  severity       String    // warning | critical
  windowType     String    // which window triggered it
  metric         String    // e.g. tierAgreementRate
  expected       Float     // baseline/threshold
  actual         Float     // observed
  message        String    // human-readable description
  acknowledged   Boolean   @default(false)
  acknowledgedAt DateTime?
  resolvedAt     DateTime?

  @@index([siteUrl, alertType, createdAt])
  @@index([acknowledged, createdAt])
  @@index([severity, createdAt])
}

// ---------------------------------------------------------------------------
// Experiment — A/B test definition with variants
// ---------------------------------------------------------------------------
model Experiment {
  id             String    @id @default(uuid())
  name           String
  description    String?
  status         String    @default("draft") // draft | running | paused | completed | cancelled
  siteUrl        String?   // null = all sites

  // Traffic allocation
  trafficPercent Int       @default(100) // % of total traffic enrolled
  variants       String    // JSON array: [{ id, name, weight, scoringConfigId?, evalEngine? }]

  // Metrics config
  primaryMetric  String    @default("conversion_rate") // conversion_rate | dismissal_rate | composite_score
  minSampleSize  Int       @default(100) // per variant

  startedAt  DateTime?
  endedAt    DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  assignments ExperimentAssignment[]
  rollout     Rollout?

  @@index([status])
  @@index([siteUrl, status])
}

// ---------------------------------------------------------------------------
// ExperimentAssignment — session → variant mapping
// ---------------------------------------------------------------------------
model ExperimentAssignment {
  id           String     @id @default(uuid())
  experimentId String
  experiment   Experiment @relation(fields: [experimentId], references: [id])
  sessionId    String
  variantId    String     // which variant this session was assigned to
  assignedAt   DateTime   @default(now())

  @@unique([experimentId, sessionId])
  @@index([experimentId, variantId])
  @@index([sessionId])
}

// ---------------------------------------------------------------------------
// Rollout — staged config change with health checks
// ---------------------------------------------------------------------------
model Rollout {
  id            String    @id @default(uuid())
  name          String
  status        String    @default("pending") // pending | rolling | paused | completed | rolled_back
  siteUrl       String?

  // What is being rolled out
  changeType    String    // scoring_config | eval_engine | gate_thresholds
  newConfigId   String?   // ScoringConfig ID for the new config
  newEvalEngine String?   // llm | fast | auto
  configPayload String?   // JSON: arbitrary config overrides

  // Staged rollout definition
  stages        String    // JSON array: [{ percent, durationHours, healthChecks }]
  currentStage  Int       @default(0)

  // Health criteria (JSON)
  healthCriteria String   // JSON: { minConversionRate, maxDismissalRate, maxDivergence, ... }

  // Linked experiment (rollout creates an experiment for traffic splitting)
  experimentId   String?  @unique
  experiment     Experiment? @relation(fields: [experimentId], references: [id])

  // Lifecycle
  startedAt        DateTime?
  completedAt      DateTime?
  rolledBackAt     DateTime?
  rollbackReason   String?
  lastHealthCheck  DateTime?
  lastHealthStatus String?   // healthy | degraded | unhealthy

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([siteUrl, status])
}
