var __defProp=Object.defineProperty,__defNormalProp=(t,e,n)=>e in t?__defProp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,__publicField=(t,e,n)=>__defNormalProp(t,"symbol"!=typeof e?e+"":e,n);!function(){"use strict";class t{static execute(t){switch(t.adjustment_type){case"inject_shipping_progress_bar":this.injectShippingBar(t);break;case"enhance_trust_signals":this.enhanceTrustSignals(t);break;case"sticky_price_bar":this.stickyPriceBar(t);break;case"inject_bnpl_callout":this.injectBNPL(t);break;case"highlight_element":this.highlightElement(t);break;case"reorder_content":this.reorderContent(t);break;default:console.log("[AVA:Passive] Unhandled adjustment:",t.adjustment_type)}}static injectShippingBar(t){const e=document.querySelector(t.target_selector||".cart-summary");if(!e||document.getElementById("sa-shipping-bar"))return;const{current_total:n,free_shipping_threshold:i}=t.params,s=Math.max(0,i-n),o=Math.min(n/i*100,100),a=document.createElement("div");a.id="sa-shipping-bar",a.innerHTML=`\n      <div style="\n        background: linear-gradient(135deg, #f0fdf4, #dcfce7);\n        border: 1px solid #bbf7d0;\n        border-radius: 10px;\n        padding: 12px 16px;\n        margin: 12px 0;\n        font-family: 'DM Sans', system-ui, sans-serif;\n        font-size: 13px;\n        color: #166534;\n        animation: sa-slideDown 0.3s ease-out;\n      ">\n        <div style="display:flex; justify-content:space-between; margin-bottom:6px;">\n          <span>${s>0?`Add $${s.toFixed(0)} more for <b>FREE shipping</b>`:"üéâ You've got <b>FREE shipping!</b>"}</span>\n          <span style="font-weight:600;">${o.toFixed(0)}%</span>\n        </div>\n        <div style="background:#d1fae5; border-radius:999px; height:6px; overflow:hidden;">\n          <div style="background:#22c55e; height:100%; width:${o}%; border-radius:999px; transition:width 0.5s ease;"></div>\n        </div>\n      </div>\n    `,e.insertBefore(a,e.firstChild)}static enhanceTrustSignals(t){const e=document.querySelector(t.target_selector||".checkout-payment");if(!e||document.getElementById("sa-trust-badges"))return;const n=t.params.badges||["ssl","money_back","secure_checkout"],i={ssl:"üîí SSL Encrypted",money_back:"üí∞ Money-Back Guarantee",secure_checkout:"üõ°Ô∏è Secure Checkout",free_returns:"‚Ü©Ô∏è Free Returns"},s=document.createElement("div");s.id="sa-trust-badges",s.innerHTML=`\n      <div style="\n        display:flex; gap:12px; flex-wrap:wrap;\n        padding:12px 0; margin:8px 0;\n        border-top:1px solid #e5e7eb;\n        font-family:'DM Sans', system-ui, sans-serif;\n        font-size:12px; color:#6b7280;\n        animation: sa-fadeIn 0.4s ease-out;\n      ">\n        ${n.map(t=>`<span style="display:flex;align-items:center;gap:4px;">${i[t]||t}</span>`).join("")}\n      </div>\n    `,e.appendChild(s)}static stickyPriceBar(t){const e=document.querySelector(t.target_selector||".product-price");if(!e||document.getElementById("sa-sticky-price"))return;const n=e.textContent;new IntersectionObserver(([t])=>{let e=document.getElementById("sa-sticky-price");t.isIntersecting?null==e||e.remove():e||(e=document.createElement("div"),e.id="sa-sticky-price",e.innerHTML=`\n              <div style="\n                position:fixed; top:0; left:0; right:0;\n                background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);\n                border-bottom:1px solid #e5e7eb;\n                padding:10px 20px;\n                display:flex; justify-content:space-between; align-items:center;\n                z-index:99998;\n                font-family:'DM Sans', system-ui, sans-serif;\n                animation: sa-slideDown 0.2s ease-out;\n              ">\n                <span style="font-size:18px;font-weight:700;color:#111;">${n}</span>\n                <button onclick="document.querySelector('.add-to-cart')?.click()"\n                  style="background:#111;color:white;border:none;padding:8px 20px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;">\n                  Add to Cart\n                </button>\n              </div>\n            `,document.body.appendChild(e))},{threshold:0}).observe(e)}static injectBNPL(t){var e;const n=document.querySelector(t.target_selector||".product-price");if(!n||document.getElementById("sa-bnpl-callout"))return;const{price:i,installments:s}=t.params,o=(i/s).toFixed(2),a=document.createElement("div");a.id="sa-bnpl-callout",a.innerHTML=`\n      <div style="\n        font-family:'DM Sans', system-ui, sans-serif;\n        font-size:13px; color:#7c3aed;\n        margin-top:6px;\n        animation: sa-fadeIn 0.3s ease-out;\n      ">\n        or <b>${s} payments of $${o}</b> with <span style="font-weight:700;">Klarna</span>\n      </div>\n    `,null==(e=n.parentNode)||e.insertBefore(a,n.nextSibling)}static highlightElement(t){const e=document.querySelector(t.target_selector||"");e&&(e.style.transition="box-shadow 0.3s ease",e.style.boxShadow="0 0 0 3px rgba(233, 69, 96, 0.4)",setTimeout(()=>{e.style.boxShadow="none"},3e3))}static reorderContent(t){var e,n;const{source_selector:i,target_selector:s,position:o}=t.params,a=document.querySelector(i),r=document.querySelector(s);a&&r&&("before"===o?null==(e=r.parentNode)||e.insertBefore(a,r):null==(n=r.parentNode)||n.insertBefore(a,r.nextSibling))}}function e(t){const{config:e,card:n,index:i,onAddToCart:s}=t,o=n.original_price&&n.original_price>n.price,a=o?Math.round((n.original_price-n.price)/n.original_price*100):0,r=document.createElement("div");r.setAttribute("style",`background:#fff;border-radius:12px;border:1px solid #f0f0f0;overflow:hidden;animation:sa-slideUp 0.3s ease-out ${.08*i}s both;cursor:pointer;transition:box-shadow 0.2s ease,transform 0.2s ease;`),r.addEventListener("mouseenter",()=>{r.style.boxShadow="0 4px 20px rgba(0,0,0,0.08)",r.style.transform="translateY(-2px)"}),r.addEventListener("mouseleave",()=>{r.style.boxShadow="none",r.style.transform="translateY(0)"});const d=document.createElement("div");d.setAttribute("style","position:relative;padding-top:75%;background:#f9fafb;overflow:hidden;");const l=document.createElement("img");if(l.src=n.image_url,l.alt=n.title,l.loading="lazy",l.setAttribute("style","position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;"),d.appendChild(l),o){const t=document.createElement("span");t.setAttribute("style",`position:absolute;top:8px;left:8px;background:${e.accentColor};color:#fff;font-size:11px;font-weight:700;padding:3px 8px;border-radius:6px;`),t.textContent=`-${a}%`,d.appendChild(t)}if(n.differentiator){const t=document.createElement("span");t.setAttribute("style","position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,0.7);color:#fff;font-size:10px;font-weight:500;padding:3px 8px;border-radius:6px;backdrop-filter:blur(4px);"),t.textContent=n.differentiator,d.appendChild(t)}r.appendChild(d);const c=document.createElement("div");c.setAttribute("style","padding:10px 12px;");const p=document.createElement("div");p.setAttribute("style","font-size:13px;font-weight:500;color:#1a1a2e;line-height:1.3;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"),p.textContent=n.title,c.appendChild(p);const u=document.createElement("div");u.setAttribute("style","display:flex;align-items:center;gap:4px;margin:4px 0;");const h=document.createElement("span");h.setAttribute("style","font-size:12px;color:#f59e0b;"),h.textContent="‚òÖ".repeat(Math.round(n.rating))+"‚òÜ".repeat(5-Math.round(n.rating));const m=document.createElement("span");m.setAttribute("style","font-size:11px;color:#9ca3af;"),m.textContent=`(${n.review_count})`,u.appendChild(h),u.appendChild(m),c.appendChild(u);const g=document.createElement("div");g.setAttribute("style","display:flex;justify-content:space-between;align-items:center;");const f=document.createElement("div"),b=document.createElement("span");if(b.setAttribute("style","font-size:16px;font-weight:700;color:#111;"),b.textContent=`$${n.price.toFixed(2)}`,f.appendChild(b),o){const t=document.createElement("span");t.setAttribute("style","font-size:12px;color:#9ca3af;text-decoration:line-through;margin-left:6px;"),t.textContent=`$${n.original_price.toFixed(2)}`,f.appendChild(t)}const x=document.createElement("button");return x.setAttribute("style",`background:${e.brandColor};color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:12px;font-weight:600;cursor:pointer;transition:background 0.2s ease,transform 0.1s ease;font-family:${e.fontFamily};`),x.textContent="+ Add",x.addEventListener("click",t=>{t.stopPropagation(),s(n.product_id)}),x.addEventListener("mousedown",()=>{x.style.transform="scale(0.95)"}),x.addEventListener("mouseup",()=>{x.style.transform="scale(1)"}),g.appendChild(f),g.appendChild(x),c.appendChild(g),r.appendChild(c),r}function n(t){var e;const{config:n,comparison:i,onSelect:s}=t,[o,a]=i.products,r=document.createElement("div");r.setAttribute("style","background:#fff;border-radius:12px;border:1px solid #f0f0f0;overflow:hidden;animation:sa-slideUp 0.3s ease-out;");const d=document.createElement("div");if(d.setAttribute("style","display:grid;grid-template-columns:1fr 1fr;gap:0;"),[o,a].forEach((t,e)=>{var s;const o=document.createElement("div");o.setAttribute("style",`padding:12px;${0===e?"border-right:1px solid #f0f0f0;":""}text-align:center;`);const a=document.createElement("div");a.setAttribute("style","width:100%;padding-top:80%;position:relative;background:#f9fafb;border-radius:8px;overflow:hidden;margin-bottom:8px;");const r=document.createElement("img");if(r.src=t.image_url,r.alt=t.title,r.setAttribute("style","position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;"),a.appendChild(r),(null==(s=i.recommendation)?void 0:s.product_id)===t.product_id){const t=document.createElement("span");t.setAttribute("style","position:absolute;top:6px;right:6px;background:#22c55e;color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;"),t.textContent="Recommended",a.appendChild(t)}o.appendChild(a);const l=document.createElement("div");l.setAttribute("style","font-size:12px;font-weight:600;color:#111;line-height:1.3;"),l.textContent=t.title,o.appendChild(l);const c=document.createElement("div");c.setAttribute("style",`font-size:16px;font-weight:700;color:${n.accentColor};margin-top:4px;`),c.textContent=`$${t.price.toFixed(2)}`,o.appendChild(c),d.appendChild(o)}),r.appendChild(d),i.differing_attributes.length>0){const t=document.createElement("div");t.setAttribute("style","border-top:1px solid #f0f0f0;"),i.differing_attributes.forEach((e,n)=>{const s=document.createElement("div");s.setAttribute("style",`display:grid;grid-template-columns:1fr auto 1fr;align-items:center;padding:8px 12px;${n<i.differing_attributes.length-1?"border-bottom:1px solid #f8f8f8;":""}font-size:12px;`);const o=document.createElement("span");o.setAttribute("style","text-align:center;color:#374151;"),o.textContent=e.values[0];const a=document.createElement("span");a.setAttribute("style","color:#9ca3af;font-size:10px;font-weight:600;background:#f3f4f6;padding:2px 8px;border-radius:4px;"),a.textContent=e.label;const r=document.createElement("span");r.setAttribute("style","text-align:center;color:#374151;"),r.textContent=e.values[1],s.appendChild(o),s.appendChild(a),s.appendChild(r),t.appendChild(s)}),r.appendChild(t)}const l=document.createElement("div");if(l.setAttribute("style","display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px;border-top:1px solid #f0f0f0;"),[o,a].forEach(t=>{var e;const o=document.createElement("button"),a=(null==(e=i.recommendation)?void 0:e.product_id)===t.product_id;o.setAttribute("style",`background:${a?n.brandColor:"#f3f4f6"};color:${a?"#fff":"#374151"};border:none;border-radius:8px;padding:8px 12px;font-size:12px;font-weight:600;cursor:pointer;font-family:${n.fontFamily};transition:all 0.2s ease;`),o.textContent="Choose This",o.addEventListener("click",()=>s(t.product_id)),l.appendChild(o)}),r.appendChild(l),null==(e=i.recommendation)?void 0:e.reason){const t=document.createElement("div");t.setAttribute("style","padding:8px 12px;background:#f0fdf4;font-size:11px;color:#166534;text-align:center;border-top:1px solid #bbf7d0;"),t.textContent=`üí° ${i.recommendation.reason}`,r.appendChild(t)}return r}class i{constructor(t,e){__publicField(this,"shadow"),__publicField(this,"config"),__publicField(this,"state","minimized"),__publicField(this,"messages",[]),__publicField(this,"currentNudge",null),__publicField(this,"isTyping",!1),__publicField(this,"hasUnread",!1),__publicField(this,"inputValue",""),__publicField(this,"root"),__publicField(this,"nudgeContainer"),__publicField(this,"panelContainer"),__publicField(this,"messagesContainer"),__publicField(this,"inputEl"),__publicField(this,"toggleBtn"),__publicField(this,"unreadDot",null),__publicField(this,"onDismiss",()=>{}),__publicField(this,"onConvert",()=>{}),__publicField(this,"onUserMessage",()=>{}),__publicField(this,"onUserAction",()=>{}),__publicField(this,"nudgeTimeout",null),this.shadow=t,this.config=e}mount(){!function(t=document.head){if(t instanceof ShadowRoot?t.querySelector("#sa-global-styles"):document.getElementById("sa-global-styles"))return;const e=document.createElement("style");e.id="sa-global-styles",e.textContent="\n    @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&display=swap');\n\n    @keyframes sa-slideUp {\n      from { opacity: 0; transform: translateY(16px) scale(0.96); }\n      to { opacity: 1; transform: translateY(0) scale(1); }\n    }\n    @keyframes sa-slideDown {\n      from { opacity: 0; transform: translateY(-10px); }\n      to { opacity: 1; transform: translateY(0); }\n    }\n    @keyframes sa-fadeIn {\n      from { opacity: 0; }\n      to { opacity: 1; }\n    }\n    @keyframes sa-scaleIn {\n      from { opacity: 0; transform: scale(0.8); }\n      to { opacity: 1; transform: scale(1); }\n    }\n    @keyframes sa-pulse {\n      0%, 100% { transform: scale(1); }\n      50% { transform: scale(1.05); }\n    }\n    @keyframes sa-shimmer {\n      0% { background-position: -200% 0; }\n      100% { background-position: 200% 0; }\n    }\n    @keyframes sa-breathe {\n      0%, 100% { box-shadow: 0 0 0 0 rgba(233, 69, 96, 0.3); }\n      50% { box-shadow: 0 0 0 8px rgba(233, 69, 96, 0); }\n    }\n    @keyframes sa-typing {\n      0%, 60%, 100% { opacity: 0.3; }\n      30% { opacity: 1; }\n    }\n\n    *, *::before, *::after {\n      box-sizing: border-box;\n    }\n  ",t.appendChild(e)}(this.shadow),this.root=this.el("div",{id:"shopassist-widget",style:`position:fixed;bottom:20px;${"bottom-right"===this.config.position?"right":"left"}:20px;z-index:${this.config.zIndex};font-family:${this.config.fontFamily};`}),this.nudgeContainer=this.el("div",{id:"ava-nudge"}),this.root.appendChild(this.nudgeContainer),this.panelContainer=this.el("div",{id:"ava-panel"}),this.panelContainer.style.display="none",this.root.appendChild(this.panelContainer),this.toggleBtn=this.buildToggleButton(),this.root.appendChild(this.toggleBtn),this.shadow.appendChild(this.root),this.render()}handleIntervention(e){switch(e.type){case"passive":e.ui_adjustment&&t.execute(e.ui_adjustment);break;case"nudge":this.currentNudge=e,this.hasUnread=!0,this.render(),this.nudgeTimeout&&clearTimeout(this.nudgeTimeout),this.nudgeTimeout=setTimeout(()=>{var t;(null==(t=this.currentNudge)?void 0:t.intervention_id)===e.intervention_id&&(this.currentNudge=null,this.render())},1e4);break;case"active":this.currentNudge=null,this.state="expanded",this.isTyping=!0,this.render(),setTimeout(()=>{this.isTyping=!1,this.messages.push({id:e.intervention_id,type:"assistant",content:e.message||"",payload:e,timestamp:Date.now()}),this.render(),this.scrollMessages()},800);break;case"escalate":this.state="expanded",this.messages.push({id:e.intervention_id,type:"system",content:e.message||"Connecting you with support...",payload:e,timestamp:Date.now()}),this.render(),this.scrollMessages()}}render(){if(this.nudgeContainer.innerHTML="","minimized"===this.state&&this.currentNudge){const t=function(t){const{config:e,message:n,ctaLabel:i,onCtaClick:s,onDismiss:o}=t,a=document.createElement("div");a.setAttribute("style",`position:absolute;bottom:72px;right:0;width:280px;background:#fff;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,0.12),0 2px 8px rgba(0,0,0,0.06);padding:0;animation:sa-slideUp 0.3s ease-out;overflow:hidden;font-family:${e.fontFamily};`);const r=document.createElement("button");r.setAttribute("style","position:absolute;top:8px;right:8px;background:none;border:none;font-size:16px;color:#9ca3af;cursor:pointer;padding:4px;line-height:1;"),r.textContent="√ó",r.setAttribute("aria-label","Dismiss"),r.addEventListener("click",o),a.appendChild(r);const d=document.createElement("div");d.setAttribute("style","padding:16px 16px 12px;");const l=document.createElement("div");l.setAttribute("style",`font-size:11px;font-weight:600;color:${e.accentColor};text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;`),l.textContent=e.assistantName,d.appendChild(l);const c=document.createElement("div");if(c.setAttribute("style","font-size:14px;line-height:1.5;color:#1a1a2e;"),c.textContent=n,d.appendChild(c),a.appendChild(d),i){const t=document.createElement("div");t.setAttribute("style","padding:0 16px 14px;");const n=document.createElement("button");n.setAttribute("style",`width:100%;background:${e.brandColor};color:#fff;border:none;border-radius:10px;padding:10px 16px;font-size:13px;font-weight:600;cursor:pointer;font-family:${e.fontFamily};transition:opacity 0.2s ease;`),n.textContent=i,n.addEventListener("click",s),n.addEventListener("mouseenter",()=>{n.style.opacity="0.9"}),n.addEventListener("mouseleave",()=>{n.style.opacity="1"}),t.appendChild(n),a.appendChild(t)}return a}({config:this.config,message:this.currentNudge.message||"",ctaLabel:this.currentNudge.cta_label,onCtaClick:()=>this.handleNudgeCtaClick(),onDismiss:()=>{this.currentNudge&&(this.onDismiss(this.currentNudge.intervention_id),this.currentNudge=null,this.render())}});this.nudgeContainer.appendChild(t)}"expanded"===this.state?(this.panelContainer.style.display="block",this.buildPanel()):this.panelContainer.style.display="none",this.toggleBtn.textContent="expanded"===this.state?"√ó":"üõçÔ∏è",this.toggleBtn.setAttribute("aria-label","expanded"===this.state?"Close assistant":"Open assistant"),this.toggleBtn.style.animation=this.hasUnread&&"expanded"!==this.state?"sa-breathe 2s ease-in-out infinite":"none",this.unreadDot&&(this.unreadDot.remove(),this.unreadDot=null),this.hasUnread&&"expanded"!==this.state&&(this.unreadDot=this.el("div",{style:`position:absolute;top:-2px;right:-2px;width:14px;height:14px;border-radius:50%;background:${this.config.accentColor};border:2px solid #fff;animation:sa-scaleIn 0.3s ease-out;`}),this.toggleBtn.appendChild(this.unreadDot))}buildPanel(){var t,i,s,o;this.panelContainer.innerHTML="";const a="bottom-right"===this.config.position,r=this.el("div",{style:`position:absolute;bottom:72px;${a?"right":"left"}:0;width:370px;max-height:520px;background:#fff;border-radius:20px;box-shadow:0 12px 60px rgba(0,0,0,0.15),0 2px 8px rgba(0,0,0,0.06);display:flex;flex-direction:column;overflow:hidden;animation:sa-slideUp 0.3s ease-out;`}),d=this.el("div",{style:`background:linear-gradient(135deg,${this.config.brandColor},${this.config.brandColorLight});padding:16px 20px;display:flex;align-items:center;justify-content:space-between;`}),l=this.el("div",{style:"display:flex;align-items:center;gap:10px;"}),c=this.el("div",{style:"width:36px;height:36px;border-radius:10px;background:rgba(255,255,255,0.15);display:flex;align-items:center;justify-content:center;font-size:18px;"});c.textContent="üõçÔ∏è";const p=this.el("div"),u=this.el("div",{style:"font-size:15px;font-weight:700;color:#fff;"});u.textContent=this.config.assistantName;const h=this.el("div",{style:"font-size:11px;color:rgba(255,255,255,0.7);"});h.textContent="Your shopping assistant",p.appendChild(u),p.appendChild(h),l.appendChild(c),l.appendChild(p);const m=this.el("button",{style:"background:rgba(255,255,255,0.15);border:none;color:#fff;width:32px;height:32px;border-radius:8px;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:background 0.2s ease;"});if(m.textContent="‚Üì",m.setAttribute("aria-label","Minimize"),m.addEventListener("click",()=>{this.state="minimized",this.hasUnread=!1,this.render()}),m.addEventListener("mouseenter",()=>{m.style.background="rgba(255,255,255,0.25)"}),m.addEventListener("mouseleave",()=>{m.style.background="rgba(255,255,255,0.15)"}),d.appendChild(l),d.appendChild(m),r.appendChild(d),this.messagesContainer=this.el("div",{style:"flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px;background:#fafafa;min-height:200px;max-height:340px;"}),0===this.messages.length&&!this.isTyping){const t=this.el("div",{style:"text-align:center;padding:40px 20px;color:#9ca3af;font-size:13px;"}),e=this.el("div",{style:"font-size:28px;margin-bottom:8px;"});e.textContent="üëã",t.appendChild(e),t.appendChild(document.createTextNode("I'm here if you need anything")),this.messagesContainer.appendChild(t)}for(const b of this.messages){const a=this.el("div");if(b.content){const t="user"===b.type,e="system"===b.type,n=this.el("div",{style:`max-width:85%;margin-left:${t?"auto":"0"};margin-right:${t?"0":"auto"};background:${t?this.config.brandColor:e?"#f0fdf4":"#fff"};color:${t?"#fff":e?"#166534":"#1a1a2e"};padding:${e?"8px 14px":"10px 16px"};border-radius:${t?"16px 16px 4px 16px":"16px 16px 16px 4px"};font-size:${e?"12px":"14px"};line-height:1.5;font-weight:${e?"500":"400"};box-shadow:${"assistant"===b.type?"0 1px 4px rgba(0,0,0,0.04)":"none"};border:${"assistant"===b.type?"1px solid #f0f0f0":e?"1px solid #bbf7d0":"none"};animation:sa-fadeIn 0.2s ease-out;`});n.textContent=b.content,a.appendChild(n)}if((null==(t=b.payload)?void 0:t.products)&&b.payload.products.length>0){const t=this.el("div",{style:"display:flex;flex-direction:column;gap:8px;margin-top:8px;max-width:95%;"});b.payload.products.slice(0,this.config.maxCardsToShow).forEach((n,i)=>{const s=e({config:this.config,card:n,index:i,onAddToCart:t=>this.handleAddToCart(t)});t.appendChild(s)}),a.appendChild(t)}if(null==(i=b.payload)?void 0:i.comparison){const t=this.el("div",{style:"margin-top:8px;max-width:95%;"}),e=n({config:this.config,comparison:b.payload.comparison,onSelect:t=>{this.handleAddToCart(t),this.onConvert(b.id,"select_comparison")}});t.appendChild(e),a.appendChild(t)}if((null==(s=b.payload)?void 0:s.cta_label)&&!(null==(o=b.payload.products)?void 0:o.length)&&!b.payload.comparison){const t=this.el("button",{style:`margin-top:8px;background:${this.config.accentColor};color:#fff;border:none;border-radius:10px;padding:10px 20px;font-size:13px;font-weight:600;cursor:pointer;font-family:${this.config.fontFamily};animation:sa-fadeIn 0.3s ease-out 0.2s both;transition:opacity 0.2s ease;`});t.textContent=b.payload.cta_label;const e=b.payload,n=b.id;t.addEventListener("click",()=>{this.onConvert(n,e.cta_action||"cta_click"),this.onUserAction(e.cta_action||"cta_click",e.meta)}),a.appendChild(t)}this.messagesContainer.appendChild(a)}this.isTyping&&this.messagesContainer.appendChild(function(){const t=document.createElement("div");t.setAttribute("style","display:flex;align-items:center;gap:4px;padding:8px 14px;background:#f3f4f6;border-radius:16px 16px 16px 4px;width:fit-content;animation:sa-fadeIn 0.2s ease-out;");for(let e=0;e<3;e++){const n=document.createElement("div");n.setAttribute("style",`width:6px;height:6px;border-radius:50%;background:#9ca3af;animation:sa-typing 1.2s ease-in-out ${.15*e}s infinite;`),t.appendChild(n)}return t}()),r.appendChild(this.messagesContainer);const g=this.el("div",{style:"padding:12px 16px;border-top:1px solid #f0f0f0;background:#fff;display:flex;gap:8px;align-items:center;"});this.inputEl=this.el("input",{style:`flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:10px 14px;font-size:14px;font-family:${this.config.fontFamily};outline:none;transition:border-color 0.2s ease;background:#fafafa;`}),this.inputEl.type="text",this.inputEl.placeholder="Ask anything...",this.inputEl.value=this.inputValue,this.inputEl.addEventListener("input",t=>{this.inputValue=t.target.value,this.updateSendButton()}),this.inputEl.addEventListener("keydown",t=>{"Enter"===t.key&&this.handleSendMessage()}),this.inputEl.addEventListener("focus",()=>{this.inputEl.style.borderColor=this.config.brandColor,this.inputEl.style.background="#fff"}),this.inputEl.addEventListener("blur",()=>{this.inputEl.style.borderColor="#e5e7eb",this.inputEl.style.background="#fafafa"});const f=this.el("button",{id:"ava-send-btn",style:`background:${this.inputValue.trim()?this.config.brandColor:"#e5e7eb"};color:${this.inputValue.trim()?"#fff":"#9ca3af"};border:none;border-radius:10px;width:40px;height:40px;cursor:${this.inputValue.trim()?"pointer":"default"};display:flex;align-items:center;justify-content:center;font-size:16px;transition:all 0.2s ease;flex-shrink:0;`});f.textContent="‚Üë",f.addEventListener("click",()=>this.handleSendMessage()),g.appendChild(this.inputEl),g.appendChild(f),r.appendChild(g),this.panelContainer.appendChild(r)}buildToggleButton(){const t=this.el("button",{style:`width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,${this.config.brandColor},${this.config.brandColorLight});color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 20px rgba(0,0,0,0.15);transition:transform 0.2s ease,box-shadow 0.2s ease;position:relative;`});return t.textContent="üõçÔ∏è",t.setAttribute("aria-label","Open assistant"),t.addEventListener("click",()=>{"expanded"===this.state?this.state="minimized":(this.state="expanded",this.currentNudge=null,this.hasUnread=!1),this.render()}),t.addEventListener("mouseenter",()=>{t.style.transform="scale(1.05)",t.style.boxShadow="0 6px 28px rgba(0,0,0,0.2)"}),t.addEventListener("mouseleave",()=>{t.style.transform="scale(1)",t.style.boxShadow="0 4px 20px rgba(0,0,0,0.15)"}),t}handleNudgeCtaClick(){this.currentNudge&&(this.onConvert(this.currentNudge.intervention_id,this.currentNudge.cta_action||"open"),"open_assistant"!==this.currentNudge.cta_action&&"open_guided_search"!==this.currentNudge.cta_action||(this.state="expanded"),this.onUserAction(this.currentNudge.cta_action||"open",this.currentNudge.meta),this.currentNudge=null,this.render())}handleAddToCart(t){this.onUserAction("add_to_cart",{product_id:t}),this.messages.push({id:`msg_${Date.now()}`,type:"system",content:"‚úì Added to cart",timestamp:Date.now()}),this.render(),this.scrollMessages()}handleSendMessage(){this.inputValue.trim()&&(this.messages.push({id:`msg_${Date.now()}`,type:"user",content:this.inputValue.trim(),timestamp:Date.now()}),this.onUserMessage(this.inputValue.trim()),this.inputValue="",this.isTyping=!0,this.render(),this.scrollMessages())}updateSendButton(){const t=this.shadow.getElementById("ava-send-btn");t&&(t.style.background=this.inputValue.trim()?this.config.brandColor:"#e5e7eb",t.style.color=this.inputValue.trim()?"#fff":"#9ca3af",t.style.cursor=this.inputValue.trim()?"pointer":"default")}scrollMessages(){this.messagesContainer&&requestAnimationFrame(()=>{this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight})}el(t,e){const n=document.createElement(t);if(e)for(const[i,s]of Object.entries(e))n.setAttribute(i,s);return n}}const s={position:"bottom-right",brandColor:"#1A1A2E",brandColorLight:"#16213E",accentColor:"#E94560",fontFamily:"'DM Sans', 'Segoe UI', system-ui, sans-serif",websocketUrl:"wss://ava-server.localhost/ws/assistant",sessionId:"",userId:null,zIndex:99999,assistantName:"AVA",maxCardsToShow:3,animationDuration:300};class o{constructor(t,e){__publicField(this,"ws",null),__publicField(this,"url"),__publicField(this,"sessionId"),__publicField(this,"listeners",new Map),__publicField(this,"reconnectAttempts",0),__publicField(this,"maxReconnectAttempts",5),__publicField(this,"reconnectDelay",1e3),__publicField(this,"messageQueue",[]),this.url=t,this.sessionId=e}connect(){try{this.ws=new WebSocket(`${this.url}?session=${this.sessionId}`),this.ws.onopen=()=>{console.log("[AVA] Connected to server"),this.reconnectAttempts=0,this.messageQueue.forEach(t=>{var e;return null==(e=this.ws)?void 0:e.send(JSON.stringify(t))}),this.messageQueue=[],this.emit("connected",{})},this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);this.emit(e.type,e.payload)}catch(e){console.error("[AVA] Failed to parse message:",e)}},this.ws.onclose=()=>{console.log("[AVA] Disconnected"),this.emit("disconnected",{}),this.attemptReconnect()},this.ws.onerror=t=>{console.error("[AVA] WebSocket error:",t)}}catch(t){console.error("[AVA] Connection failed:",t),this.attemptReconnect()}}attemptReconnect(){this.reconnectAttempts>=this.maxReconnectAttempts||(this.reconnectAttempts++,console.log(`[AVA] Reconnecting in ${this.reconnectDelay*this.reconnectAttempts}ms...`),setTimeout(()=>this.connect(),this.reconnectDelay*this.reconnectAttempts))}send(t,e){var n;const i={type:t,payload:e,session_id:this.sessionId,timestamp:Date.now()};(null==(n=this.ws)?void 0:n.readyState)===WebSocket.OPEN?this.ws.send(JSON.stringify(i)):this.messageQueue.push(i)}sendTrackEvent(t){var e,n;const i="undefined"!=typeof window?window:void 0,s={type:"track",visitorKey:this.sessionId,sessionKey:this.sessionId,siteUrl:(null==(e=null==i?void 0:i.location)?void 0:e.origin)??"",deviceType:i?i.innerWidth<768?"mobile":i.innerWidth<1024?"tablet":"desktop":"desktop",referrerType:"direct",isLoggedIn:!1,isRepeatVisitor:!1,event:t};(null==(n=this.ws)?void 0:n.readyState)===WebSocket.OPEN?this.ws.send(JSON.stringify(s)):this.messageQueue.push(s)}on(t,e){return this.listeners.has(t)||this.listeners.set(t,new Set),this.listeners.get(t).add(e),()=>{var n;return null==(n=this.listeners.get(t))?void 0:n.delete(e)}}emit(t,e){var n;null==(n=this.listeners.get(t))||n.forEach(t=>t(e))}disconnect(){var t;null==(t=this.ws)||t.close(),this.listeners.clear()}}class a{constructor(t,e,n){__publicField(this,"bridge"),__publicField(this,"observers",[]),__publicField(this,"timers",[]),__publicField(this,"scrollDepth",0),__publicField(this,"pageEnterTime",Date.now()),__publicField(this,"rageClickTracker",{count:0,lastTime:0,lastX:0,lastY:0}),__publicField(this,"scrollMilestones",new Set),__publicField(this,"lastProductModalId",null),__publicField(this,"productModalOpenedAt",0),this.bridge=t}startCollecting(){this.emitPageView(),this.trackProductViews(),this.trackClicks(),this.trackScrollDepth(),this.trackRageClicks(),this.trackHoverIntent(),this.trackFormFriction(),this.trackCopyEvents(),this.trackExitIntent(),this.trackIdleTime(),this.trackPageVisibility(),this.trackSearch()}send(t,e,n,i=null){this.bridge.sendTrackEvent({event_id:`evt_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,friction_id:i,category:t,event_type:e,raw_signals:n,page_context:{page_type:this.detectPageType(),page_url:window.location.href,time_on_page_ms:Date.now()-this.pageEnterTime,scroll_depth_pct:this.scrollDepth,viewport:{width:window.innerWidth,height:window.innerHeight},device:this.detectDevice()},timestamp:Date.now()})}extractProductContext(t){var e,n,i,s,o,a,r,d,l,c,p,u,h,m,g,f,b,x,y,v;const _=t.closest(".product-card, [data-id]");if(_){const t=(null==(n=null==(e=_.querySelector("h3"))?void 0:e.textContent)?void 0:n.trim())||(null==(s=null==(i=_.querySelector("[class*='product-name']"))?void 0:i.textContent)?void 0:s.trim()),p=null==(a=null==(o=_.querySelector("[data-analyze='price'], .price-tag"))?void 0:o.textContent)?void 0:a.trim(),u=(null==(d=null==(r=_.querySelector("[class*='text-amber']"))?void 0:r.textContent)?void 0:d.trim())||(null==(c=null==(l=_.querySelector(".category"))?void 0:l.textContent)?void 0:c.trim());return{product_id:_.dataset.id||null,product_name:t||null,product_price:p||null,product_category:u||null,source:"product_card"}}const C=t.closest("#product-modal")||document.getElementById("product-modal");if(C&&!C.classList.contains("hidden")){return{product_name:(null==(u=null==(p=C.querySelector("h2"))?void 0:p.textContent)?void 0:u.trim())||(null==(m=null==(h=C.querySelector("[class*='product-title']"))?void 0:h.textContent)?void 0:m.trim())||null,product_price:(null==(f=null==(g=C.querySelector("[data-analyze='price'], .price-tag"))?void 0:g.textContent)?void 0:f.trim())||(null==(x=null==(b=C.querySelector("span.font-bold"))?void 0:b.textContent)?void 0:x.trim())||null,product_category:(null==(v=null==(y=C.querySelector("[class*='text-amber']"))?void 0:y.textContent)?void 0:v.trim())||null,source:"product_modal"}}return null}getElementLabel(t){var e;return t.getAttribute("aria-label")||t.getAttribute("title")||(null==(e=t.textContent)?void 0:e.trim().slice(0,80))||t.tagName}emitPageView(){this.send("navigation","page_view",{referrer:document.referrer||"direct",page_title:document.title})}trackProductViews(){const t=document.getElementById("product-modal");if(!t)return;const e=new MutationObserver(()=>{if(t.classList.contains("hidden")){if(this.lastProductModalId){const t=Date.now()-this.productModalOpenedAt;this.send("product","product_detail_close",{product_name:this.lastProductModalId,view_duration_ms:t})}this.lastProductModalId=null,this.productModalOpenedAt=0}else setTimeout(()=>{var e,n,i,s,o,a,r,d;const l=null==(n=null==(e=t.querySelector("h2"))?void 0:e.textContent)?void 0:n.trim(),c=(null==(s=null==(i=t.querySelector("[data-analyze='price'], .price-tag"))?void 0:i.textContent)?void 0:s.trim())||(null==(a=null==(o=t.querySelector(".font-bold.text-2xl, .font-bold.text-xl"))?void 0:o.textContent)?void 0:a.trim()),p=null==(d=null==(r=t.querySelector("[class*='text-amber']"))?void 0:r.textContent)?void 0:d.trim(),u=l||"";u&&u!==this.lastProductModalId&&(this.lastProductModalId=u,this.productModalOpenedAt=Date.now(),this.send("product","product_detail_view",{product_name:l||"Unknown",product_price:c||"N/A",product_category:p||"unknown"}))},100)});e.observe(t,{attributes:!0,attributeFilter:["class"]}),this.observers.push(e)}trackClicks(){document.addEventListener("click",t=>{var e,n,i,s,o,a,r,d,l,c,p,u,h;const m=t.target,g=m.closest("[data-action='add-to-cart'], .add-to-cart"),f=!g&&(null==(n=null==(e=m.closest("button"))?void 0:e.textContent)?void 0:n.toLowerCase().includes("add to cart"));if(g||f){const t=this.extractProductContext(m);return void this.send("cart","add_to_cart",{...t,button_text:null==(s=null==(i=g||m.closest("button"))?void 0:i.textContent)?void 0:s.trim().slice(0,50)})}const b=m.closest(".btn-add[data-id]");if(b){const t=this.extractProductContext(m);return void this.send("cart","quick_add",{product_id:b.dataset.id,...t})}if(m.closest(".product-trigger"))return;const x=m.closest(".nav-category, [data-cat]");if(x)return void this.send("navigation","category_browse",{category:x.getAttribute("data-cat")||(null==(o=x.textContent)?void 0:o.trim())});const y=m.closest("[data-nav], nav a");if(y)return void this.send("navigation","nav_click",{link_text:null==(a=y.textContent)?void 0:a.trim(),href:y.href||null});const v=m.closest(".color-option, [data-color]");if(v){const t=this.extractProductContext(m);return void this.send("product","color_select",{color:v.getAttribute("data-color")||v.getAttribute("title")||"unknown",...t})}const _=m.closest(".size-option, [data-size]");if(_){const t=this.extractProductContext(m);return void this.send("product","size_select",{size:(null==(r=_.textContent)?void 0:r.trim())||_.getAttribute("data-size"),...t})}if("BUTTON"===m.tagName&&("+"===m.textContent||"-"===m.textContent)){const t=this.extractProductContext(m),e=null==(d=m.parentElement)?void 0:d.querySelector("span");return void this.send("cart","quantity_change",{direction:"+"===m.textContent?"increase":"decrease",current_qty:(null==(l=null==e?void 0:e.textContent)?void 0:l.trim())||"unknown",...t})}const C=document.getElementById("product-modal");if(C&&!C.classList.contains("hidden")&&m.closest("button, [role='tab']")){const t=null==(c=m.textContent)?void 0:c.trim();if(t&&["Details","Returns","Reviews"].includes(t)){const e=this.extractProductContext(m);return void this.send("product","tab_view",{tab_name:t,...e})}}const w=m.closest("[data-sort], select");if(w&&"SELECT"===w.tagName)return void this.send("navigation","sort_change",{sort_value:w.value||(null==(p=w.textContent)?void 0:p.trim())});if(m.closest("#cart-count, .cart-icon, [data-cart]"))return void this.send("cart","cart_icon_click",{cart_count:(null==(h=null==(u=document.getElementById("cart-count"))?void 0:u.textContent)?void 0:h.trim())||"0"});const k=m.closest("a, button");if(k){const t=this.extractProductContext(m),e=this.getElementLabel(k);if(e.length<=1&&!t)return;this.send("engagement","click",{element:k.tagName,text:e,...t})}})}trackSearch(){const t=document.getElementById("store-search");if(!t)return;let e=null;t.addEventListener("input",()=>{e&&clearTimeout(e),e=window.setTimeout(()=>{const e=t.value.trim();e.length>=2&&this.send("search","search_query",{query:e,query_length:e.length})},800)})}trackScrollDepth(){window.addEventListener("scroll",()=>{const t=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight),e=window.scrollY+window.innerHeight,n=Math.round(e/t*100);this.scrollDepth=Math.max(this.scrollDepth,n);for(const i of[25,50,75])n>=i&&!this.scrollMilestones.has(i)&&(this.scrollMilestones.add(i),this.send("navigation","scroll_depth",{depth_pct:i}));if(n>=95){0===parseInt(sessionStorage.getItem("sa_click_count")||"0")&&this.send("navigation","scroll_without_click",{scroll_depth:n,click_count:0},"F015")}},{passive:!0})}trackRageClicks(){document.addEventListener("click",t=>{var e;const n=Date.now(),i=Math.abs(t.clientX-this.rageClickTracker.lastX),s=Math.abs(t.clientY-this.rageClickTracker.lastY);if(n-this.rageClickTracker.lastTime<500&&i<30&&s<30){if(this.rageClickTracker.count++,this.rageClickTracker.count>=3){const n=t.target,i=this.extractProductContext(n);this.send("technical","rage_click",{target_element:n.tagName,target_text:null==(e=n.textContent)?void 0:e.trim().slice(0,50),click_count:this.rageClickTracker.count,...i},"F400"),this.rageClickTracker.count=0}}else this.rageClickTracker.count=1;this.rageClickTracker.lastTime=n,this.rageClickTracker.lastX=t.clientX,this.rageClickTracker.lastY=t.clientY;const o=parseInt(sessionStorage.getItem("sa_click_count")||"0");sessionStorage.setItem("sa_click_count",String(o+1))})}trackHoverIntent(){let t=null;document.addEventListener("mouseover",e=>{var n;const i=e.target;(i.closest("[data-action='add-to-cart']")||i.closest(".add-to-cart")||(null==(n=i.textContent)?void 0:n.toLowerCase().includes("add to cart")))&&(t=window.setTimeout(()=>{const t=this.extractProductContext(i);this.send("product","hover_add_to_cart",{hover_duration_ms:3e3,...t},"F058")},3e3))}),document.addEventListener("mouseout",()=>{t&&(clearTimeout(t),t=null)})}trackFormFriction(){let t=0;document.addEventListener("invalid",e=>{var n;t++,t>=2&&this.send("checkout","form_validation_error",{error_count:t,field_name:null==(n=e.target)?void 0:n.name},"F091")},!0),document.addEventListener("focusin",t=>{const e=t.target;"INPUT"===e.tagName&&"hidden"!==e.type&&(e.dataset.saFocusTime=String(Date.now()))}),document.addEventListener("focusout",t=>{var e,n;const i=t.target;if(i.dataset.saFocusTime){const t=Date.now()-parseInt(i.dataset.saFocusTime);t>3e4&&((null==(e=i.name)?void 0:e.includes("card"))||(null==(n=i.name)?void 0:n.includes("payment")))&&this.send("checkout","payment_hesitation",{field_name:i.name,hesitation_ms:t},"F094")}})}trackCopyEvents(){document.addEventListener("copy",()=>{var t;const e=(null==(t=window.getSelection())?void 0:t.toString())||"";/\$[\d,.]+/.test(e)?this.send("product","copy_price",{copied_text:e.slice(0,50)},"F060"):e.length>3&&this.send("engagement","copy_text",{copied_text:e.slice(0,80)})})}trackExitIntent(){document.addEventListener("mouseout",t=>{if(t.clientY<=0&&null===t.relatedTarget){const t=parseFloat(sessionStorage.getItem("sa_cart_value")||"0");t>0&&this.send("cart","exit_intent_with_cart",{cart_value:t},"F068")}})}trackIdleTime(){let t;const e=()=>{clearTimeout(t),t=window.setTimeout(()=>{const t=parseInt(sessionStorage.getItem("sa_cart_items")||"0");t>0&&this.send("cart","idle_with_cart",{idle_ms:3e5,cart_items:t},"F069")},3e5)};["mousemove","keydown","scroll","touchstart"].forEach(t=>{document.addEventListener(t,e,{passive:!0})}),e()}trackPageVisibility(){let t=null;document.addEventListener("visibilitychange",()=>{if(document.hidden)t=Date.now();else if(t){const e=Date.now()-t;e>6e4&&this.send("engagement","tab_return",{away_duration_ms:e}),t=null}})}detectPageType(){const t=window.location.pathname.toLowerCase();return"/"===t||"/home"===t?"landing":t.includes("/category")||t.includes("/collection")?"category":t.includes("/search")?"search_results":t.includes("/product")||t.includes("/item")||t.includes("/p/")?"pdp":t.includes("/cart")||t.includes("/bag")?"cart":t.includes("/checkout")?"checkout":t.includes("/account")||t.includes("/profile")?"account":"other"}detectDevice(){const t=window.innerWidth;return t<768?"mobile":t<1024?"tablet":"desktop"}stopCollecting(){this.observers.forEach(t=>t.disconnect()),this.timers.forEach(t=>clearTimeout(t))}}function r(t){const e={...s,...t};let n=document.getElementById("ava-widget-root");n||(n=document.createElement("div"),n.id="ava-widget-root",document.body.appendChild(n));const r=n.attachShadow({mode:"open"}),d=new i(r,e);d.mount();const{bridge:l,collector:c}=function(t){const e={...s,...t},n=new o(e.websocketUrl,e.sessionId);n.connect();const i=new a(n,e.sessionId,e.userId);return i.startCollecting(),{bridge:n,collector:i}}(e);return l.on("intervention",t=>{d.handleIntervention(t)}),d.onDismiss=t=>{l.send("dismiss",{intervention_id:t})},d.onConvert=(t,e)=>{l.send("conversion",{intervention_id:t,action:e})},d.onUserMessage=t=>{l.send("user_message",{text:t})},d.onUserAction=(t,e)=>{l.send("user_action",{action:t,data:e})},window.__AVA_WIDGET__=d,window.__AVA_BRIDGE__=l,window.__AVA_COLLECTOR__=c,{widget:d}}if(window.ShopAssist={init:r},window.__AVA_CONFIG__||window.ShopAssistConfig){r(window.__AVA_CONFIG__||window.ShopAssistConfig)}}();
